<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Marketing Streams Demo</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 2rem;
      background-color: #f5f5f5;
      color: #222;
    }
    header {
      margin-bottom: 1.5rem;
    }
    h1 {
      font-size: 1.8rem;
      margin: 0 0 0.5rem 0;
    }
    button {
      background-color: #0b7285;
      border: none;
      color: #fff;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0c8599;
    }
    .card {
      background-color: #fff;
      border-radius: 6px;
      padding: 1rem 1.2rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .alert {
      border-left: 4px solid;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
    }
    .alert.success {
      border-color: #2f9e44;
      background-color: #ebfbee;
    }
    .alert.error {
      border-color: #c92a2a;
      background-color: #fff5f5;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    th, td {
      padding: 0.75rem 0.9rem;
      border-bottom: 1px solid #e1e1e1;
      text-align: left;
    }
    th {
      background-color: #0c8599;
      color: #fff;
      position: sticky;
      top: 0;
    }
    tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    details {
      margin-top: 0.5rem;
    }
    code {
      background-color: #f1f3f5;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      font-size: 0.9rem;
    }
    .refresh-control {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-top: 1rem;
      padding: 0.75rem;
      background-color: #fff;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #e1e1e1;
      border-top-color: #0b7285;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .spinner.hidden {
      visibility: hidden;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .action-btn {
      width: 100px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Marketing Streams Demo</h1>
    <p>Simulates customer lifecycle using event streaming and Delta Lake.</p>
  </header>

  <div class="card">
    <button type="button" id="createCustomerBtn">Create New Customer</button>
  </div>

  <div id="statusMessages"></div>

  {% if data_error %}
    <div class="alert error">
      {{ data_error }}
    </div>
  {% else %}
    <div class="card">
      <h2>
        Consolidated Customers (limit {{ result_limit }})
        <span class="spinner hidden" id="refreshSpinner"></span>
      </h2>
      <div style="overflow-x: auto;">
        <table id="customersTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Email</th>
              <th>Lifecycle</th>
              <th>Status</th>
              <th>Orders</th>
              <th>LTV</th>
              <th>Last Order</th>
              <th>Activations</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="customersBody">
            {% if customers %}
              {% for row in customers %}
                <tr>
                  <td>{{ row.customer_id }}</td>
                  <td>{{ row.first_name }} {{ row.last_name }}</td>
                  <td>{{ row.email or "—" }}</td>
                  <td>{{ row.lifecycle_stage or "—" }}</td>
                  <td>
                    {% if row.is_active is none %}
                      —
                    {% elif row.is_active %}
                      Active
                    {% else %}
                      Inactive
                    {% endif %}
                  </td>
                  <td>{{ row.order_count or 0 }}</td>
                  <td>{{ "%.2f"|format(row.lifetime_value) if row.lifetime_value is not none else "—" }}</td>
                  <td>
                    {% if row.last_order_at %}
                      <div>{{ row.last_order_at }}</div>
                      <div><code>{{ row.last_order_ts }}</code></div>
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>
                    {% set delivered = row.delivered_messages or 0 %}
                    {% set failed = row.failed_messages or 0 %}
                    {% set total = delivered + failed %}
                    {% if total > 0 %}
                      {% set rate = (delivered / total * 100) | int %}
                      <div>Total: {{ total }} ({{ rate }}%)</div>
                      <div><small>✓ {{ delivered }} / ✗ {{ failed }}</small></div>
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>
                    <p><button type="button" class="action-btn" data-action="order" data-customer-id="{{ row.customer_id }}">Buy</button></p>
                    <p><button type="button" class="action-btn" data-action="engage" data-customer-id="{{ row.customer_id }}">Engage</button></p>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="10">No consolidated customers found yet. Use the button above to create the first profile.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  <script>
    const messagesContainer = document.getElementById('statusMessages');
    const customersTable = document.getElementById('customersTable');
    const customersBody = document.getElementById('customersBody');
    const createCustomerBtn = document.getElementById('createCustomerBtn');
    const refreshSpinner = document.getElementById('refreshSpinner');
    const POLL_INTERVAL_MS = 5000;
    let pollTimer = null;
    let refreshInFlight = false;

    function showSpinner() {
      if (refreshSpinner) {
        refreshSpinner.classList.remove('hidden');
      }
    }

    function hideSpinner() {
      if (refreshSpinner) {
        refreshSpinner.classList.add('hidden');
      }
    }

    function showMessage(text, type = 'success') {
      if (!text) {
        return;
      }
      const alert = document.createElement('div');
      alert.className = `alert ${type === 'error' ? 'error' : 'success'}`;
      alert.textContent = text;
      messagesContainer.appendChild(alert);
      setTimeout(() => {
        alert.classList.add('hidden');
        alert.remove();
      }, 8000);
    }

    function textCell(value) {
      const td = document.createElement('td');
      td.textContent = value ?? '—';
      return td;
    }

    function lifecycleCell(row) {
      const td = document.createElement('td');
      td.textContent = row.lifecycle_stage || '—';
      return td;
    }

    function statusCell(row) {
      const td = document.createElement('td');
      if (row.is_active === null || row.is_active === undefined) {
        td.textContent = '—';
      } else {
        td.textContent = row.is_active ? 'Active' : 'Inactive';
      }
      return td;
    }

    function lastOrderCell(row) {
      const td = document.createElement('td');
      if (row.last_order_at) {
        const divMain = document.createElement('div');
        divMain.textContent = row.last_order_at;
        const divCode = document.createElement('div');
        const code = document.createElement('code');
        code.textContent = row.last_order_ts ?? '';
        divCode.appendChild(code);
        td.appendChild(divMain);
        td.appendChild(divCode);
      } else {
        td.textContent = '—';
      }
      return td;
    }

    function activationsCell(row) {
      const td = document.createElement('td');
      const delivered = Number(row.delivered_messages || 0);
      const failed = Number(row.failed_messages || 0);
      const total = delivered + failed;
      if (total > 0) {
        const rate = Math.floor((delivered / total) * 100);
        const totalDiv = document.createElement('div');
        totalDiv.textContent = `Total: ${total} (${rate}%)`;
        const detailDiv = document.createElement('div');
        const small = document.createElement('small');
        small.textContent = `✓ ${delivered} / ✗ ${failed}`;
        detailDiv.appendChild(small);
        td.appendChild(totalDiv);
        td.appendChild(detailDiv);
      } else {
        td.textContent = '—';
      }
      return td;
    }

    function renderCustomers(customers) {
      if (!customersBody) {
        return;
      }
      customersBody.innerHTML = '';
      if (!Array.isArray(customers) || customers.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 10;
        cell.textContent = 'No consolidated customers found yet. Use the button above to create the first profile.';
        row.appendChild(cell);
        customersBody.appendChild(row);
        return;
      }

      customers.forEach((row) => {
        const tr = document.createElement('tr');
        const fullName = [row.first_name, row.last_name].filter(Boolean).join(' ').trim();
        tr.appendChild(textCell(row.customer_id));
        tr.appendChild(textCell(fullName || '—'));
        tr.appendChild(textCell(row.email || '—'));
        tr.appendChild(lifecycleCell(row));
        tr.appendChild(statusCell(row));
        tr.appendChild(textCell(row.order_count ?? 0));
        const ltvCell = document.createElement('td');
        ltvCell.textContent = row.lifetime_value !== null && row.lifetime_value !== undefined ? Number(row.lifetime_value).toFixed(2) : '—';
        tr.appendChild(ltvCell);
        tr.appendChild(lastOrderCell(row));
        tr.appendChild(activationsCell(row));

        const actionsTd = document.createElement('td');
        const buyBtn = document.createElement('button');
        buyBtn.type = 'button';
        buyBtn.className = 'action-btn';
        buyBtn.dataset.action = 'order';
        buyBtn.dataset.customerId = row.customer_id;
        buyBtn.textContent = 'Buy';

        const engageBtn = document.createElement('button');
        engageBtn.type = 'button';
        engageBtn.className = 'action-btn';
        engageBtn.dataset.action = 'engage';
        engageBtn.dataset.customerId = row.customer_id;
        engageBtn.textContent = 'Engage';

        const buyWrapper = document.createElement('p');
        buyWrapper.appendChild(buyBtn);
        const engageWrapper = document.createElement('p');
        engageWrapper.appendChild(engageBtn);

        actionsTd.appendChild(buyWrapper);
        actionsTd.appendChild(engageWrapper);
        tr.appendChild(actionsTd);
        customersBody.appendChild(tr);
      });
    }

    async function fetchJSON(url, options = {}) {
      const response = await fetch(url, options);
      let data = null;
      try {
        data = await response.json();
      } catch (err) {
        data = null;
      }
      if (!response.ok) {
        const errorMessage = data && data.error ? data.error : response.statusText;
        const error = new Error(errorMessage);
        error.status = response.status;
        error.payload = data;
        throw error;
      }
      return data || {};
    }

    async function refreshCustomers(force = false) {
      if (refreshInFlight && !force) {
        return;
      }
      refreshInFlight = true;
      showSpinner();
      try {
        const payload = await fetchJSON('/api/customers');
        renderCustomers(payload.customers || []);
        if (payload.error) {
          showMessage(payload.error, 'error');
        }
      } catch (err) {
        showMessage(err.message || 'Unable to load customers.', 'error');
      } finally {
        hideSpinner();
        refreshInFlight = false;
      }
    }

    function startPolling() {
      if (pollTimer) {
        clearInterval(pollTimer);
      }
      pollTimer = setInterval(() => {
        refreshCustomers();
      }, POLL_INTERVAL_MS);
    }

    function stopPolling() {
      if (pollTimer) {
        clearInterval(pollTimer);
        pollTimer = null;
      }
    }

    async function handleCreateCustomer() {
      createCustomerBtn.disabled = true;
      try {
        const payload = await fetchJSON('/api/customers', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({}),
        });
        if (payload.message) {
          showMessage(payload.message, 'success');
        }
        await refreshCustomers(true);
      } catch (err) {
        showMessage(err.message || 'Failed to create customer.', 'error');
      } finally {
        createCustomerBtn.disabled = false;
      }
    }

    async function handleRowAction(action, customerId, button) {
      if (!customerId) {
        showMessage('Missing customer id.', 'error');
        return;
      }
      button.disabled = true;
      const endpoint = action === 'order'
        ? `/api/customers/${encodeURIComponent(customerId)}/order`
        : `/api/customers/${encodeURIComponent(customerId)}/engage`;
      try {
        const payload = await fetchJSON(endpoint, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({}),
        });
        if (payload.message) {
          showMessage(payload.message, 'success');
        }
        await refreshCustomers(true);
      } catch (err) {
        showMessage(err.message || 'Action failed.', 'error');
      } finally {
        button.disabled = false;
      }
    }

    if (createCustomerBtn) {
      createCustomerBtn.addEventListener('click', handleCreateCustomer);
    }

    if (customersTable) {
      customersTable.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-action][data-customer-id]');
        if (!button) {
          return;
        }
        const action = button.dataset.action;
        const customerId = button.dataset.customerId;
        handleRowAction(action, customerId, button);
      });
    }

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        stopPolling();
      } else {
        refreshCustomers(true);
        startPolling();
      }
    });

    refreshCustomers(true).then(() => {
      startPolling();
    });
  </script>
</body>
</html>
